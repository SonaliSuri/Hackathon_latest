<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opencv JS</title>
    <script async src="js/opencv.js" onload="openCvReady();"></script>
    <script src="js/utils.js"></script>

</head>
<body>

    <h1>OpenCV Camera Slow</h1>
    <div>
        <button id="actionBtn">Start</button>
    </div>
    <video id="cam_input" width="450" height="300"></video>
    <canvas id="canvasOutput"></canvas>

</body>
</html>


<script type="text/JavaScript">
function openCvReady() {

    let streaming = false;
    const video = document.getElementById('video');
    const actionBtn = document.getElementById('actionBtn');
    const width = 450;
    const height = 300;
    let cap;
    let src;
    let dst;
    let gray;
    let faces;
    let classifier;
    let utils;
    let faceCascadeFile;
    let rect;

    var imageString = "D///ALL/APL/ALT/AK//AIT/AHr/ACr/AACAAACUAABfAABkAABpAABpAABcAABSAABVAABkAAB1AACEAAB4AABkAABfAABaAABiAAB4AABzAABuAABmAABiAABcAABcAABcAABcAABSAABBAAAyAAAyAAA+AABIAABBAAA5AABBAABaAABSAABwAABVAACRAADzAADNAAClAACOAADSAHP/ANT/AOj/AIz/AJv/AHD/AEj/AAL9ADT/ABz/AABzAACEAABpAABVAABOAABSAABQAABBAABGAABVAABsAAB6AABwAABcAABfAABfAABfAABuAABiAABfAABaAABYAABSAABQAABOAABOAABGAAA3AAAqAAAqAAA0AAA5AAA3AAAyAAAqAABOAABQAAB4AABIAABuAACRAABuAACCAABsAAB6AACyAAC+D///AHb/AET/ACb/AADhAADAAADmAADaAACMAAB1AAB1AABcAABOAABOAABIAAA8AAA5AABGAABcAABzAABsAABVAABaAABfAABfAABmAABVAABSAABSAABOAABLAABGAABBAAA+AAA8AAAyAAAoAAAmAAAqAAAwAAAwAAAtAAAqAABGAABSAAB4AAA+AABGAABQAABLAABBAABpAABmAABuAACgCP7/AEj/AAD4AADoAACoAACyAADAAACoAACgAABzAABzAABkAABVAABOAABGAAA8AAA5AAA+AABIAABuAABsAABSAABSAABaAABcAABiAABLAABLAABLAABLAABGAABBAAA5AAA3AAA0AAAwAAAoAAAjAAAmAAAoAAAqAAAtAAA5AABBAABOAABYAAAwAAAqAAA5AABIAABBAABmAABLAABkAAb+AHP/ABL/AAClAACsAAB6AAB9AACUAACEAAB9AABkAABaAABfAABaAABLAABBAABBAABBAAA8AAA5AABpAABwAABSAABLAABSAABaAABkAABGAABIAABLAABLAABGAAA+AAA3AAAyAAAyAAAwAAAqAAAmAAAjAAAmAAAqAAAwAAA3AAA3AABGAAAtAAAqAAAqAAA5AAA8AABVAABfAABkAABkAACEAACgAADNAACHAACbAABwAABSAACAAACHAABkAABuAABBAABVAABYAABGAAA8AABEAABGAAA+AAAwAABmAABzAABSAABGAABOAABYAABkAABEAABGAABLAABLAABGAAA+AAA0AAAwAAAyAAAwAAAtAAAoAAAjAAAmAAAqAAAyAAAoAAAqAABEAAAUAAAwAAA3AAA+AAAjAABLAAA0AAClAAD6AAC0AAC8AACRAACKAABuAABfAABYAABOAABYAABfAABSAABIAABGAABBAAA5AAA0AAA0AAA5AAA8AABBAABYAABkAABfAABSAABQAABLAABBAABLAABLAABOAABOAAA+AAAtAAAtAAA8AAAwAAAqAAAjAAAeAAAeAAAjAAAoAAAtAAAqAAAWAAAPAAAbAAAqAAAtAAAtAAAyAABBAABBAABQAACYAABGAACbAACCAACUAACUAACWAAB9AABIAAA0AAA+AABEAAA3AAA+AAA8AAAtAAAgAAAoAABEAABaAABGAABcAABsAABmAABcAABaAABVAABOAAA3AAA3AAA+AABGAAA+AAAqAAAgAAAmAAAoAAAmAAAgAAAeAAAgAAAmAAAqAAAwAAAmAAAZAAAUAAAgAAAmAAAjAAAjAAAqAAA0AABLAAA8AAA8AAA5AACYAACKAACMAACUAACiAACKAABQAAA0AAA+AABBAAA5AAAqAAAyAABGAAA+AAAjAAAmAAA+AABkAAB4AACCAABzAABiAABYAABOAABBAAA3AAAtAAAtAAA5AAA+AAA3AAAyAAA0AAAmAAAjAAAgAAAeAAAeAAAgAAAjAAAmAAAeAAAZAAAbAAAjAAAeAAAWAAAZAAAoAABSAABEAABcAABmAACAAAClAACqAACRAAB9AAB1AABsAABSAABIAABEAAAyAAA0AAAZAAAmAABLAABBAAAbAAA3AAB6AADIAADcAADkAADSAADAAAC0AAClAACYAAB4AABcAABGAABGAABIAABIAABIAABOAABBAAA8AAA3AAAwAAAoAAAjAAAeAAAbAAASAAASAAAZAAAgAAAZAAASAAAbAAAwAAA8AAASAABLAABaAABGAADIAACeAACgAAB1AABaAABIAAA8AAA5AAAwAAASAAAWAAAbAAAeAAAZAAAbAABQAADAACb/ACb/ADz/AEv/AET/ADr/ADT/ADD/ACb/AAb+AADkAADDAAC0AACqAACbAACUAACUAACHAACAAAB1AABmAABVAABEAAA0AAAtAAASAAAPAAAUAAAbAAAWAAAUAAAmAAA8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AACOAABpAAA5AAAeAAAbAAAKAAAPAAAWAAAgAAAqAACUAABkAABmAABfAABBAABIAABVAABcAABGAACqAGL/AMb/AND/ANT/APL/AOH/AND/AMj/APX/APL/APD/AOv/AOT/ANr/AND/AMj/AKr/AJ7/AJb/AJj/AJj/AIf/AGz/AFj/AEb/ACD/AAL9AADzAADmAADUAADQAADXAADKAACyAACoAACUAABiAAA3AAAjAAAUAAAUAAAMAAASAAAmAAA0AACgAACAAABkAABaAABBAABIAABSAABcAABIAACqAFz/AL7/ANT/ANr/ANz/AMr/AN7/AO7/AMb/AOb/APj/AOv/AN7/AOH/ANz/AM3/AKr/AJb/AIz/AJT/AJ7/AJH/AHb/AFr/AET/ACj/ABT/AA3/AAD8AADfAADNAADIAADQAAC5AACvAACWAABaAAAwAAAjAAAeAAAWAAAPAAASAAAgAAAtAADQAAB6AABiAABVAABBAABOAABSAABfAABOAACoAI7/ANf/APD/APj/ANz/AKz/AIz/AFj/AIL/AIr/AIz/AIT/AIL/AJj/AMb/AOv/ALz/AKL/AIf/AIL/AIr/AIr/AHD/AFj/AFz/ADr/ABT/AAb+AAD6AADuAADkAADhAADGAAC5AAC2AACYAABVAAAmAAAjAAAmAAAbAAASAAASAAAeAAAjAADXAACoAABmAABVAABGAABYAABVAABiAABSAACiAIf/AM3/ANz/ALn/AHP/ADf/AAT+AACeAACAAABaAABQAABwAACRAAC8ABz/AID/AJH/AJH/AIf/AHr/AGz/AFX/AC3/AAr/AADoAAC0AAB6AABkAABwAACHAACRAACRAACgAACiAACyAACbAABSAAAeAAAeAAAoAAAeAAAUAAAUAAAgAAAoAADaAACWAAB1AABcAABVAABpAABYAABkAABYAACeAI7/APD/APL/AJT/ADf/ADr/AGb/AD7/AFD/ABz/AADrAADXAADKAADKAADuAB7/AEH/AGn/AIT/AHb/AEv/ABT/AADXAACoAAB9AABcAAA+AABEAABiAAB4AABuAABVAAB6AACKAACoAACbAABSAAAeAAAbAAAmAAAgAAAWAAAZAAAoAAAwAET/AAL9AACMAABpAABpAAB9AABfAABmAABaAACWAHr/ANr/AMb/AHD/AFD/AIz/ANr/AND/AKz/AJT/AFj/ABn/AAr/ACj/AEb/AE7/AFr/AH3/AIL/AFL/ABT/AADrAADKAAC0AAC2AADGAADhAAL9ABb/AA//AADcAACoAAB4AACEAACiAACWAABSAAAeAAAeAAAmAAAjAAAZAAAbAAAqAAA0AAD1AADAAACiAAB6AAB6AACOAABmAABsAABcAACRAIf/AN7/AM3/AK//AMP/ANz/AOH/AL7/AMb/AJT/AEj/AAb+AADuAAr/AEb/AHP/AKz/AK//AID/ACb/AADhAADSAADXAADUAADwABn/AD7/AET/ADf/ACD/AAD8AADaAACeAACeAACoAACRAABOAAAgAAAjAAAtAAAoAAAeAAAbAAAmAAAtAFj/AACEAACyAACEAACHAACYAABpAABsAABcAACMAF//AMb/AND/AMj/AND/AJ7/AHD/AFL/AET/AADwAAC2AAC0AACoAACiAAD6AHD/AMP/ALn/AHr/ABb/AADQAAC+AAC8AACvAAD8AB7/ACb/AAD6AADKAAC+AADKAADUAADIAAC5AACvAACOAABIAAAgAAAoAAA0AAAqAAAgAAAbAAAgAAAjAA//AAL9ABT/AADQAACKAADGAAC8AACCAAB6AACMAFX/AN7/APD/ALn/AGn/AAD1AAC5AACvAABVAAA0AAAjAAA+AABmAABmAACgABb/AGT/AJT/AHr/ABb/AAC+AACMAABwAABsAACMAACHAACRAABwAAA5AAA+AABwAAB9AAC+AAC5AADGAACgAABGAAAmAAAwAAAtAAAWAAAtAABGAAAoAABBACr/AC3/AADGAACeAACKAFj/ADr/AADzAABzAACWAHD/ANT/AM3/AKj/AJH/AHD/AH3/AJj/AHr/AEH/AADkAACyAAClAACYAADIACb/AGn/AID/AFz/AAb+AACyAAB1AABfAABuAABpAACgAADDAACsAACWAACiAACRAABcAACeAACeAAC2AACiAABQAAAgAAAqAAA0AAB4AABcAAAeAABmAACAAADcAAClAACHAABsAACbAJv/AJv/AEH/AAB9AACWAJv/ANr/AL7/AKD/AJj/AH3/AH3/AH3/AGL/AEH/AAL9AADUAADUAADoABn/AFj/AJH/AIz/AGL/ABn/AADKAACHAAB1AACRAAC0AADmAAD1AADmAAD4AAb+AADfAACsAACbAACeAAC8AAC5AABpAAAmAAAtAABLAACUAACCAAAtAABwAAA+AABGAAB1AABzAABcAAC5AHP/ALb/AFD/AAC2AADDAKz/ANf/AMP/AMD/AMD/AJj/AHb/AE7/ABb/AA//AAb+AA3/ACj/AEj/AHP/AJv/AJ7/AJb/AGz/ACj/AADkAACiAACHAACbAAC+AADAAACsAAC0AADXAADQAAC2AADAAADGAADAAADXAADXAACMAAA3AAA5AABwAAB1AAB9AABaAABzAABsAACsAACAAABwAABiAACyAHr/AMb/AE7/AADQAAb+ANf/AOT/AMr/ANT/AOb/ANT/AMP/AJv/AH3/AGb/AGT/AHj/AIf/AJb/ALL/AMr/AKX/AKj/AID/ADz/AAT+AADKAACiAACeAADkAAD1AAD4AA3/ACr/ABL/AADwAAD8AADoAADcAADhAADhAACgAABLAABOAACUAAC0AACUAABsAAC+AADfAAC2AAC2AABwAABmAAB6ALL/AMb/ADL/AACbAAb+APj/APL/ANT/AOH/AO7/AOT/AOT/AMP/ALT/AJT/AI7/AJj/AJH/AJT/AKD/AKD/ALb/ALn/AI7/AFD/ACD/AADrAAC8AACsAADQAAj/AC3/ADr/AEv/AEj/ACj/AAj/AADuAADhAADXAADUAACoAABaAABYAACbAADDAAB1AAA8ACr/AHD/AACiAABpAABzAABpAABGAJj/ALz/ABb/AACoABL/AOT/AOb/AN7/Bf3/D///Bf3/FP//AOv/AMD/AJv/AID/AGb/AFj/AHr/AJv/AIz/AND/ALn/AIT/AFX/ACr/AADuAADDAADAAAC0AADXAA3/AC3/ADz/AEj/ADf/AA//AADuAADoAADXAADQAAC0AABmAABQAACEAADhAAB9AAAjAADSABn/AABuAACCAABzAABmAAA0AET/AL7/ACD/ABT/AFj/AOj/AOv/AOv/Gf//FP//Avz/I///APj/ALz/AIr/AFD/ABb/ABz/AI7/APL/APX/Bf3/AND/AJT/AHD/AEj/AAT+AADcAADwAACiAACbAADfADf/AEj/ADz/ADD/ABb/AAD6AAD6AADkAADaAADAAABwAABEAABmAADAAACCAABIAABOAACMAACoAACsAABfAAA+AABkAADzANf/AADAAKX/AHb/AMr/APr/APr/CP7/Gf//KP//Hv//ANL/AKL/ABz/AADuAC3/AHb/AMD/AOT/AMP/AO7/ANT/AGb/AHr/AGL/AADwAAT+ACD/AADIAACYAACvABb/AFj/AET/ACP/ACj/ABL/AAL9AADhAAT+AAC0AAClAACbAAA0AAC8AABfAABzAAA3AABmAADQAACCAACMAABuAAA+AADQGf//AH3/ANf/AMb/ALT/APX/Bf3/APr/APL/APj/APr/AMj/AGz/AADmAADmAHP/AMP/ALT/AGn/AA//AHP/AKL/AIf/AGT/AAD8AACOAAClAADDAACyAACWAACYAADfAC3/ADr/ACr/ADT/AAr/AAT+AADoAADrAACoAAC0AACqAABpAADrAAAqAAAeAABYAACRAAB6AABmAAB6AACqAAB4AAB1CP7/C///AOv/ALn/AKD/AOv/APX/AOH/ANL/ANf/ANr/AKX/AAD6AADoADT/AJT/AJH/AHD/AHD/AHb/AHb/AIr/AH3/ADz/AADcAACgAACKAABuAACYAACgAACRAACoAAD4ACD/ABn/ABz/AADkAADmAADkAADNAACbAADDAAC0AACqAADKAABuAAAeAADUAC3/AAC8AEj/AAC8AAB6AABsAAAZAND/APX/APD/AO7/AJ7/ANr/AND/ALb/ALn/AMr/ALn/AGL/AADkAAD4ADD/AFX/AFX/AFX/ADz/AAr/AADSAAb+AF//AEv/AADkAAClAACCAABzAAB4AACgAACOAACEAADNAAj/AAT+AAD4AADkAADcAADmAADQAACoAADQAAC2AADfAACiAABaAAAmAADXAB7/ACj/AEH/AB7/AADIAACqAAAPAFj/Lf//PP//ALz/AKr/AMj/AJ7/AIT/AKr/AND/AJ7/ABT/AACYAAL9AGT/AHP/AFL/AE7/AFX/AEv/AAT+AADIAADIAAC0AAB4AABmAACCAACqAAB1AACgAACMAABuAACiAADrAAD6AADrAADmAADGAADIAADAAACgAADDAAC0AADwAADhAAAqAAAgAABEAACiPP//S///AI7/AD7/AADKAABGAAClAMb/Gf//ANz/AK//AMD/AID/AGL/AJj/AMr/AIT/AADaAAC8AAL9AFr/AKD/AMb/AMb/AKr/AJH/AFj/AA3/AADhAAL9AAT+AADXAAC2AACeAAC0AAC8AACgAABzAAB6AAC+AADkAADSAADQAACoAACeAAC2AAClAADUAADfAAD6AABVAABEAAC5AADXAAA3eP//X///ALT/AADuAABSAACKAABVAACyADL/AN7/AKL/AL7/AID/AFL/AIL/ALb/AHD/AAC+AAB9AAb+AID/AKD/AIf/AGb/AFj/AFr/ACj/ADr/AAT+AAD1AADaAACvAADQAADXAADaAAC+AACyAACOAABzAACoAADcAADIAADAAACsAACgAADNAAC8AADrAADzAAC2AAA8AAAUAAB6AAj/AACCkf//ALz/AAL9AADAAAB9AACyAABuAAA0AAAtAAAqAJb/AMD/AIr/AFL/AG7/AKD/AGL/AAC8AABmAAC5AADXAADSABn/AIf/AKz/AJj/AJv/AND/AGb/ADT/ACP/AAD4AAD8AAC+AADAAACbAACsAACqAACEAAC2AAD1AADcAACoAACsAACbAADGAACgAAC8AAClAAAPAAAjAABYAAD8AAB1AACspf//pf//AKz/AAD4ADL/ADD/AAA5AABVAABzAAAZAHP/ALT/AJj/AF//AG7/AKz/AGz/AADUAABcAABVAAAZAMj/S///X///Vf//h///af//ff//X///Bf3/KP//AL7/AJH/AJv/AF//AADAAAA+AABOAAClAADUAADNAAC5AADDAACYAACqAADzAABmAAAKAAAwAABEAABGAACMAIr/AID/AOv/pf//pf//AJ7/AAC+AAr/AAD4AABVAACRAAB6AAAmACD/ANz/AIL/AFz/AGT/AKD/AH3/AADuAACsAADKAABBAHr/UP//ff//Gf//h///ZP//gv//af//Qf//af//APL/AL7/AMP/AG7/AADQAABBAABBAACgAADhAADfAADDAACeAACbAACsAACyAACYAABwAABzAAAwAAB4AABQAEj/X///D///qv//qv//AKr/ALT/AADNAACsAACAAACbAACeAABfAADDAPL/AIz/AIT/AH3/AKL/AJb/AAD8AADKAJ7/AB7/AADIAA3/AMP/AMb/AHb/ALL/ALn/AJb/AIz/AHj/ADT/AADaAADKAACUAABwAABmAACWAADfAAb+AADuAADIAACyAACyAADUAACvAACeAABGAAAeAAA+AAACAABcAABLAGb/ZP//qv//qv//Gf//AND/AACyAADfAAB4AFr/AKr/AACMAACYAKX/AJT/AI7/AH3/AKD/ALb/AB7/ACD/AKD/AL7/AGb/ADD/ALL/Rv//Bf3/Gf//I///AOv/APr/ANr/AKz/AEj/ADT/AACEAACYAACvAADDAADfAAD4AADzAADfAACoAACsAADXAAC0AAC8AAClAACRABn/ABb/AABuAEH/AA//jP//r///r///N///I///Hv//AKX/ADD/Rv//c///AN7/AAD8AGT/AMb/AJv/AHP/AIr/AKr/AB7/AGz/AID/ANr/AOb/AKz/AHr/AKD/AKD/APD/AOT/ALT/ALb/AID/AEv/AADoAADIAADaAADaAADKAADAAADSAADoAADhAADDAAC0AAC5AAC0AACCAAD4AOH/AOT/APj/I///AL7/AKr/gv//Lf//r///r///ff//uf//UP//AJT/h///zf//KP//UP//AAL9AAD4AMb/AKz/AIr/AI7/AIz/ABL/ABz/AKD/ANz/AMD/AO7/AMb/AKL/AH3/AHP/AGb/AFr/AGz/AFz/AEj/ACD/ABL/AADAAADaAADmAADcAADUAADSAADDAACsAADIAACqAAC8AAB6AADfD///vv//ZP//Lf//Lf//APj/APD/kf//r///r///r///jP//eP//Vf//tP//X///9f//eP//AACbAACeAHj/AJj/AJT/AJ7/AIL/ADz/AEj/AKD/AMD/ANz/FP//ALz/AKz/AJ7/AEv/AC3/ACr/ACD/ABb/AAD6AAD6AADuAAL9AAr/AAL9AADXAACvAACiAACvAAC8AACeAACUAFL/AAD8AACRAADzC///oP//gv//oP//Avz/ff//S///r///r///0v//m///w///vv//kf//9f//gv//Wv//AAD1AAr/AIf/AJ7/AIz/AIz/AGb/AFL/AFD/AFr/AI7/AOb/AOH/AL7/ANz/AGT/ADz/ABb/ACD/AAr/AA3/AADwABL/AA3/AAj/AADwAADQAAC5AACvAACoAACgAACWAACgAADolv//AKL/AABmAAAPALn/vv//w///Qf//w///pf//c///qv//qv//qv//qv//qv//qv//qv//qv//qv//qv//S///bv//AJj/AJH/AKL/AG7/AJb/AFr/ADz/AEv/AGz/AJH/AL7/AOH/ALz/AGn/AC3/ACP/AAr/AADrAADcAADfAADoAADrAAD6AADuAADUAAC8AACiAACUAACOAACOAACiADL/ff//ZP//AN7/AET/AMP/lv//oP//oP//oP//oP//oP//qv//qv//qv//qv//qv//qv//qv//qv//qv//qv//lv//c///AKz/AKX/ALL/AH3/AIT/AFj/AF//AGL/AHP/AIT/AJH/AKj/AKz/AJT/AHD/AF//AEH/AB7/AAj/AAT+AAj/AAr/AAD1AADuAADaAAC8AACgAACWAACgAACsAADkADL/FP//ZP//h///APX/Vf//qv//oP//oP//oP//oP//oP//qv//qv//qv//qv//qv//qv//qv//qv//qv//qv//r///qv//Lf//Avz/ANL/AIT/AHP/AHP/AGT/AGL/AHj/AIf/AHr/AIT/AKz/AMP/AJv/AHj/AEH/ABT/AAD4AADzAAD8AAr/AADrAADmAADSAAC0AACYAACYAAC0AADQAADGAB7/AOv/Wv//r///kf//oP//pf//oP//oP//oP//oP//oP//qv//qv//qv//qv//qv//qv//qv//qv//qv//qv//oP//w///1///ff//APD/AKL/AGn/AGT/AFD/AFX/AHb/AIz/AIL/AIf/AKD/AKz/AID/AFr/AC3/AA3/AAD1AADkAADfAADkAADaAADNAAC2AACgAACWAACiAADAAADXAACsADT/PP//m///oP//tP//pf//tP//oP//oP//oP//oP//oP//qv//qv//qv//qv//qv//qv//qv//qv//qv//qv//qv//r///w///Wv//APX/AND/AHb/ADf/ADz/AD7/AFj/AG7/AHj/AIL/AHr/AFr/ADL/ABz/AA//AA//AAL9AADcAAC5AACsAADDAACvAACWAACOAACYAACvAADAAADIAAC2AE7/jP//uf//r///1///pf//lv//oP//oP//oP//oP//oP//qv//qv//qv//qv//qv//qv//qv//qv//qv//qv//r///w///zf//S///AOT/ANT/AKD/AF//ADD/AB7/ACP/ADf/AEv/AGL/AFX/ACr/ABn/AAD4AADkAADoAADmAADKAAC0AACyAACqAACYAACKAACOAACoAAC5AAC8AAC2AACeAEH/tP//qv//m///r///kf//kf//oP//oP//oP//oP//oP//qv//qv//qv//qv//qv//qv//qv//qv//qv//qv//oP//1///3P//c///AOH/AMb/AMr/AKL/AFj/AC3/AB7/ACP/ACD/ACD/AB7/ABL/ACP/AADwAADNAADSAADXAADGAAC+AADIAACUAACRAACWAAClAAC5AADAAAC5AACvAACRADf/3P//oP//oP//lv//oP//uf//oP//oP//oP//oP//oP//qv//qv//qv//qv//qv//qv//qv//qv//qv//qv//m///qv//jP//bv//APL/AM3/ANf/AKD/AKL/AGb/AEb/ADr/AA3/AADfAADcAADoAADuAADGAAC2AADNAADSAAC0AACYAACUAACEAACUAACoAAC8AADGAADDAAC5AACvAACbACb/uf//af//tP//pf//oP//kf//oP//oP//oP//oP//oP//qv//qv//lv//lv//m///oP//oP//pf//pf//qv//r///uf//X///AJb/APD/ANz/ALT/AL7/AKD/AIz/AHb/AGT/AFL/ADL/AAT+AADfAADGAADAAAC5AAC0AACyAACyAAC0AAC2AACvAAC0AAC8AADAAADAAADAAAC8AAC5AADNAADmCP7/4f//ff//r///jP//uf//oP//oP//oP//oP//oP//qv//qv//oP//oP//oP//pf//pf//qv//qv//qv//w///w///AOH/AEj/AOT/AMj/AMr/AMr/AKj/AJj/AIz/AIr/AIf/AHj/AFX/ADr/AADwAADoAADaAADIAAC5AACyAACsAACqAAC0AAC5AAC+AADDAADDAADAAAC+AAC8AADDAADDAAr/ZP//6///c///uf//ff//oP//oP//oP//oP//oP//"
    imageByte = decoder.decodeBuffer(imageString);
    cv['onRuntimeInitialized']=()=>{
        let video = document.getElementById("cam_input"); // video is the id of video tag
        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(function(stream) {
            video.srcObject = stream;
            video.play();
        })
        .catch(function(err) {
            console.log("An error occurred! " + err);
        });

        cap = new cv.VideoCapture(cam_input);
        faces = new cv.RectVector();
        classifier = new cv.CascadeClassifier();
        utils = new Utils('errorMessage');
        faceCascadeFile = 'haarcascade_frontalface_default.xml'; // path to xml
        utils.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {
            classifier.load(faceCascadeFile); // in the callback, load the cascade from file
        });
    }

    actionBtn.addEventListener('click', () => {
        if (streaming) {
            stop();
            actionBtn.textContent = 'Start';
        } else {
            start();
            actionBtn.textContent = 'Stop';
        }
    });


    function start () {
        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(_stream => {
            let video = document.getElementById("cam_input"); // video is the id of video tag
        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(function(stream) {
            video.srcObject = stream;
            video.play();
        })
        .catch(function(err) {
            console.log("An error occurred! " + err);
        });


        stream = _stream;
        console.log('stream', stream);
        video.srcObject = stream;
        video.play();
        streaming = true;


        src = new cv.Mat(height, width, cv.CV_8UC4);
        dst = new cv.Mat(height, width, cv.CV_8UC1);
        gray = new cv.Mat(height, width, cv.CV_8UC1);
        faces = new cv.RectVector();
        setTimeout(processVideo, 0)
        })
        .catch(err => console.log(`An error occurred: ${err}`));
    }

    function stop () {
        if (video) {
            video.pause();
            video.srcObject = null;
        }
        if (stream) {
            stream.getVideoTracks()[0].stop();
        }
        streaming = false;
    }

    const FPS = 1;
    function processVideo() {
        if (!streaming) {
            src.delete();
            dst.delete();
            return;
        }

        let begin = Date.now();
        cap.read(src);
        src.copyTo(dst);
        cv.cvtColor(dst, gray, cv.COLOR_RGBA2GRAY, 0);
        // cv.applyColorMap(dst, cv.COLORMAP_HOT);

        let tempCanvas = document.createElement("canvas");
        cv.imshow(tempCanvas, dst)

        let b64image = tempCanvas.toDataURL()
        var myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");

        var raw = JSON.stringify({"image":b64image.split(',')[1]});

        var requestOptions = {
          method: 'POST',
          headers: myHeaders,
          body: raw,
          redirect: 'follow'
        };

        const proxyurl = "https://cors-anywhere.herokuapp.com/";
        const serverurl = "https://sunhacks-292004.wl.r.appspot.com/detect_mask";

        fetch(proxyurl + serverurl, requestOptions)
          .then(response => response.text())
          .then(
                    result => {
                    if (result.startsWith("{", 0)){
                        console.log("valid");
                        console.log(JSON.parse(result));

                        result = JSON.parse(result);


                        cv.putText(
                            dst, 
                            result["mask"] +":"+ result["score"],
                            new cv.Point(50, 50),
                            cv.FONT_ITALIC,
                            1, 
                            [0, 0, 255, 255], 
                            2, 
                            cv.LINE_4
                        )

                        console.log(parseInt(result["xmin"]), parseInt(result["xmax"]), parseInt(result["ymin"]));
                        let point1 = new cv.Point(parseInt(result["xmin"]), parseInt(result["ymin"]));
                        let point2 = new cv.Point(parseInt(result["xmax"]), parseInt(result["ymax"]));
                        cv.rectangle(dst, point1, point2, [255, 0, 0, 255]);
                        //dst = cv.applyColorMap(dst, cv.COLORMAP_HOT);

                    }
                    else{
                        console.log("not valid");
                    }
                    cv.imshow('canvasOutput', dst);
                    setTimeout(processVideo, 0);
                    }
               )
          .catch(error => console.log('error', error));

    }
}

</script>
